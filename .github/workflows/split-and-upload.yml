name: Split an Existing Artifact into Multiple Artifacts

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: "Source workflow run ID (the run that produced the artifact)"
        required: true
      artifact_name:
        description: "Exact artifact name in that run (as shown in the UI)"
        required: true
      part_size_mb:
        description: "Chunk size in MB (e.g., 1024 = 1GB)"
        required: false
        default: "1024"
      artifact_prefix:
        description: "Prefix used to name the output chunk artifacts"
        required: true

jobs:
  download_and_split:
    runs-on: ubuntu-latest
    outputs:
      parts_json: ${{ steps.manifest.outputs.parts_json }}
    steps:
      - name: Download artifact from the specified run
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.inputs.run_id }}
          name: ${{ github.event.inputs.artifact_name }}
          path: downloaded

      - name: Show what was downloaded
        run: |
          echo "Downloaded contents:"
          du -h downloaded || true
          ls -lahR downloaded || true

      - name: Pick the file to split (largest file in the artifact)
        id: pick
        shell: bash
        run: |
          set -euo pipefail
          # Find the largest regular file under 'downloaded'
          target="$(find downloaded -type f -printf '%s\t%p\n' | sort -nr | head -1 | cut -f2-)"
          if [ -z "$target" ]; then
            echo "No file found in the artifact; ensure it contains the ISO (or desired file)."
            exit 1
          fi
          echo "TARGET=$target" >> $GITHUB_ENV
          echo "Chosen file to split: $target"

      - name: Split into parts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p parts
          size_mb="${{ github.event.inputs.part_size_mb }}"
          # Create 3-digit numeric suffixes: .part_000, .part_001, ...
          split -b "$(( size_mb * 1024 * 1024 ))" -d -a 3 \
                "$TARGET" "parts/${{ github.event.inputs.artifact_prefix }}.part_"
          echo "Created parts:"
          ls -lh parts

      - name: Build JSON manifest for the parts (for matrix)
        id: manifest
        shell: bash
        run: |
          python3 - << 'PY'
import json, os
parts = sorted(os.listdir('parts'))
print("Parts:", parts)
with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
    f.write(f"parts_json={json.dumps(parts)}\n")
PY

      # Pass the actual part files to the next job via a temporary artifact.
      # (This is internal to Actions; you won't download this one.)
      - name: Upload internal bundle of parts for next job
        uses: actions/upload-artifact@v4
        with:
          name: _parts_internal_bundle
          path: parts/*
          retention-days: 1

  publish_parts:
    needs: download_and_split
    runs-on: ubuntu-latest
    strategy:
      matrix:
        part: ${{ fromJSON(needs.download_and_split.outputs.parts_json) }}
    steps:
      - name: Download the internal bundle
        uses: actions/download-artifact@v4
        with:
          name: _parts_internal_bundle
          path: parts

      - name: Upload this part as its own artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.artifact_prefix }}-${{ matrix.part }}
          path: parts/${{ matrix.part }}
          retention-days: 30
