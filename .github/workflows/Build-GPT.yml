name: Build Full Installer ISO/DMG image (Release, Chunked)

on:
  workflow_dispatch:
    inputs:
      macos_version:
        description: 'Select a macOS version to build'
        required: true
        type: choice
        options:
          - 'Tahoe'
          - 'Sequoia'
          - 'Sonoma'
          - 'Ventura'
          - 'Monterey'
          - 'Big Sur'
          - 'Catalina'
          - 'Mojave'
          - 'High Sierra'
          - 'Sierra'
          - 'El Capitan'
          - 'Yosemite'
          - 'Mavericks'
          - 'Mountain Lion'
          - 'Lion'
      image_format:
        description: 'Select image format: iso for virtual machines, dmg for flash to USB drive'
        required: true
        type: choice
        options:
          - 'iso'
          - 'dmg'
      chunk_size_gb:
        description: 'Chunk size in GB (max 2 GB for GitHub Releases)'
        required: false
        default: '2'
        type: string

jobs:
  build-macos-image:
    runs-on: macos-15-intel
    timeout-minutes: 70

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: System Information
        run: |
          echo "Runner OS: $(sw_vers -productName) $(sw_vers -productVersion)"
          echo "Architecture: $(uname -m)"
          echo ""
          df -h $(mktemp)
          echo ""
          echo "RAM: $(top -l 1 | grep PhysMem || true)"
          echo ""
          echo "CPU: $(sysctl -n machdep.cpu.brand_string)"

      - name: Build macOS image
        id: create_image
        run: |
          set -euo pipefail
          if [ "${{ github.event.inputs.image_format }}" = "iso" ]; then
            sudo bash mkmaciso "${{ github.event.inputs.macos_version }}" iso
            IMAGE_FILE="$(ls -1 *.iso | head -n1)"
          else
            sudo bash mkmaciso "${{ github.event.inputs.macos_version }}" dmg
            IMAGE_FILE="$(ls -1 *.dmg.img | head -n1)"
          fi

          if [ -z "${IMAGE_FILE:-}" ] || [ ! -f "$IMAGE_FILE" ]; then
            echo "No image file produced." >&2
            exit 1
          fi

          echo "image_file=$IMAGE_FILE" >> "$GITHUB_OUTPUT"
          echo "image_name=$(basename "$IMAGE_FILE")" >> "$GITHUB_OUTPUT"

      - name: Compute checksum and manifest
        id: manifest
        run: |
          set -euo pipefail
          IMAGE_FILE="${{ steps.create_image.outputs.image_file }}"
          IMAGE_NAME="${{ steps.create_image.outputs.image_name }}"

          echo "Computing SHA-256 checksum for $IMAGE_FILE ..."
          shasum -a 256 "$IMAGE_FILE" | awk '{print $1}' > "${IMAGE_NAME}.sha256"

          {
            echo "image_name=$IMAGE_NAME"
            echo "image_bytes=$(stat -f%z "$IMAGE_FILE")"
            echo "sha256=$(cat "${IMAGE_NAME}.sha256")"
            echo "macos_version=${{ github.event.inputs.macos_version }}"
            echo "image_format=${{ github.event.inputs.image_format }}"
          } > "${IMAGE_NAME}.manifest.txt"

      - name: Split into 2GB chunks (max allowed for Releases)
        id: split
        run: |
          set -euo pipefail
          IMAGE_FILE="${{ steps.create_image.outputs.image_file }}"
          IMAGE_NAME="${{ steps.create_image.outputs.image_name }}"
          # sanitize and clamp chunk size to 2 GB (GitHub Release asset limit)
          REQ_GB="${{ github.event.inputs.chunk_size_gb }}"
          if ! [[ "$REQ_GB" =~ ^[0-9]+$ ]] || [ "$REQ_GB" -le 0 ]; then
            REQ_GB=2
          fi
          if [ "$REQ_GB" -gt 2 ]; then
            echo "Requested chunk size ${REQ_GB}GB > 2GB; clamping to 2GB for Releases."
            REQ_GB=2
          fi
          CHUNK_BYTES="$(( REQ_GB * 1024 * 1024 * 1024 ))"

          echo "Splitting $IMAGE_FILE into ${REQ_GB}GB parts ..."
          # Numeric suffixes: part-00, part-01, ...
          split -b "${CHUNK_BYTES}" -a 2 -d "$IMAGE_FILE" "${IMAGE_NAME}.part-"
          PART_COUNT=$(ls -1 "${IMAGE_NAME}.part-"* | wc -l | tr -d ' ')
          echo "Created $PART_COUNT parts."
          echo "part_count=$PART_COUNT" >> "$GITHUB_OUTPUT"

          # Reassembly script (bash)
          cat > REASSEMBLE.sh <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          if [ $# -lt 1 ]; then
            echo "Usage: $0 <ImageBaseName>" >&2
            exit 1
          fi
          IMAGE_BASENAME="$1"
          cat "${IMAGE_BASENAME}.part-"* > "${IMAGE_BASENAME}"
          echo "Wrote ${IMAGE_BASENAME}"
          if [ -f "${IMAGE_BASENAME}.sha256" ]; then
            echo "Verifying SHA-256 checksum..."
            if command -v shasum >/dev/null 2>&1; then
              calc=$(shasum -a 256 "${IMAGE_BASENAME}" | awk '{print $1}')
            else
              calc=$(sha256sum "${IMAGE_BASENAME}" | awk '{print $1}')
            fi
            want=$(cat "${IMAGE_BASENAME}.sha256")
            if [ "$calc" != "$want" ]; then
              echo "Checksum mismatch! expected=$want got=$calc" >&2
              exit 2
            fi
            echo "Checksum OK"
          fi
          EOF
          chmod +x REASSEMBLE.sh

          # Reassembly script (PowerShell)
          cat > REASSEMBLE.ps1 <<'EOF'
          Param(
            [Parameter(Mandatory=$true)]
            [string]$ImageBaseName
          )
          $outFile = "$ImageBaseName"
          $parts = Get-ChildItem "$($ImageBaseName).part-*" | Sort-Object Name
          if ($parts.Count -eq 0) {
            Write-Error "No parts found for $ImageBaseName"
            exit 1
          }
          $out = [System.IO.File]::OpenWrite($outFile)
          foreach ($p in $parts) {
            $in = [System.IO.File]::OpenRead($p.FullName)
            $in.CopyTo($out)
            $in.Dispose()
          }
          $out.Dispose()
          Write-Host "Wrote $outFile"
          $shaFile = "$ImageBaseName.sha256"
          if (Test-Path $shaFile) {
            Write-Host "Verifying SHA-256 checksum..."
            $calc = (Get-FileHash -Path $outFile -Algorithm SHA256).Hash.ToLower()
            $want = (Get-Content $shaFile).Trim().ToLower()
            if ($calc -ne $want) {
              Write-Error "Checksum mismatch! expected=$want got=$calc"
              exit 2
            }
            Write-Host "Checksum OK"
          }
          EOF

      - name: Ensure GitHub CLI is available
        run: |
          set -e
          gh --version || brew install gh

      - name: Create or update release for this run
        env:
          GH_TOKEN: ${{ github.token }}
        id: release
        run: |
          set -euo pipefail
          TAG="build-${{ github.run_id }}"
          TITLE="macOS ${{
            github.event.inputs.macos_version
          }} â€¢ ${{ steps.create_image.outputs.image_name }} â€¢ run ${{ github.run_id }}"
          BODY="Auto-generated build for macOS ${{ github.event.inputs.macos_version }} (${{ github.event.inputs.image_format }}).
          Triggered by workflow run ${{ github.run_id }}.
          This release contains chunked parts (2GB max per asset), a checksum, a manifest, and reassembly scripts."

          # Create if missing; otherwise do nothing
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists."
          else
            gh release create "$TAG" -t "$TITLE" -n "$BODY"
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Upload chunks and support files as release assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG="${{ steps.release.outputs.tag }}"
          IMAGE_NAME="${{ steps.create_image.outputs.image_name }}"

          # Upload parts
          for f in ${IMAGE_NAME}.part-*; do
            echo "Uploading $f ..."
            gh release upload "$TAG" "$f" --clobber
          done

          # Upload checksum, manifest, and helper scripts
          for f in "${IMAGE_NAME}.sha256" "${IMAGE_NAME}.manifest.txt" REASSEMBLE.sh REASSEMBLE.ps1; do
            echo "Uploading $f ..."
            gh release upload "$TAG" "$f" --clobber
          done

      - name: Summary
        if: always()
        run: |
          set -euo pipefail
          OUTCOME="${{ job.status }}"
          IMG="${{ steps.create_image.outputs.image_name }}"
          TAG="${{ steps.release.outputs.tag }}"
          REPO="${{ github.server_url }}/${{ github.repository }}"
          REL_URL="${REPO}/releases/tag/${TAG}"
          CHECKSUM="$(cat "${IMG}.sha256" 2>/dev/null || echo 'n/a')"
          PARTS="${{ steps.split.outputs.part_count || '0' }}"

          if [ "$OUTCOME" != "success" ]; then
            {
              echo "## Download macOS failed"
              echo ""
              echo "> [!WARNING]"
              echo "> This runner may have network issues. Please **re-run the workflow** to try a different runner."
            } >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          {
            echo "## âœ… Built and uploaded **${IMG}** as chunked Release assets"
            echo ""
            echo "- Release: ${REL_URL}"
            echo "- Total parts: **${PARTS}** (2GB chunks, last may be smaller)"
            echo "- SHA-256: \`${CHECKSUM}\`"
            echo ""
            echo "### ðŸ“¥ Download (GitHub CLI, recommended)"
            echo '```powershell'
            echo "gh auth login"
            echo "gh release download ${TAG} --repo ${{ github.repository }} --dir . --pattern '${IMG}.part-*'"
            echo "gh release download ${TAG} --repo ${{ github.repository }} --dir . --pattern '${IMG}.sha256'"
            echo "gh release download ${TAG} --repo ${{ github.repository }} --dir . --pattern 'REASSEMBLE.ps1'"
            echo '```'
            echo ""
            echo "### ðŸ§© Reassemble"
            echo "**Windows (PowerShell):**"
            echo '```powershell'
            echo "./REASSEMBLE.ps1 -ImageBaseName '${IMG}'"
            echo '```'
            echo ""
            echo "**macOS/Linux:**"
            echo '```bash'
            echo "chmod +x REASSEMBLE.sh && ./REASSEMBLE.sh '${IMG}'"
            echo '```'
            echo ""
            echo "> After reassembly, you will have the original file:"
            echo "> - ISO: \`${IMG}\` for Proxmox/QEMU/VMware/VirtualBox"
            echo "> - DMG(IMG): \`${IMG}\` for USB flashing or VM (convert as needed)"
          } >> "$GITHUB_STEP_SUMMARY"
